#!/bin/sh

docker-compose start

echo "Waiting for database..."
# Gotta use "sh", not "/bin/sh", or Windows 10 gives error:
# stat: C:/Program Files/Git/usr/bin/sh: no such file or directory
docker run -i -t \
  --link overview-dev-database \
  --rm busybox \
  sh -c 'until $(echo | nc overview-dev-database 5432 2>/dev/null); do sleep 1; done'

echo "Compiling and applying latest schema..."
./sbt '; common/compile; worker/compile; compile; db-evolution-applier/run'

echo "Starting worker..."
# Funky sbt syntax puts blob-storage in the right place
./sbt '; project worker; run' &
PID1=$!

echo "Starting web server..."
./sbt run

set +e

kill $PID1
wait $PID1
